import{find,Node,director,Component,AudioSource,Asset,Prefab,instantiate,isValid,assetManager}from"cc";class Injector{static inject(t,e){e instanceof Function?this.__injectedMap.set(t,e):this.__instanceMap.set(t,e)}static getInject(t){let e=this.__instanceMap.get(t);if(e)return e;let s=this.__injectedMap.get(t);return void 0===s?null:(e=new s,this.__instanceMap.set(t,e),e)}}Injector.__injectedMap=new Map,Injector.__instanceMap=new Map;class EventDispatcher{constructor(){this.callerMap=new Map,this.keyMap=new Map}on(t,e,s,i=0){let n,r;if(this.keyMap.has(t)){n=this.keyMap.get(t);for(const i of n)if(i.target==s&&i.handler==e)return void console.error("重复添加同一个事件监听："+t+" "+s+" "+e)}else n=[],this.keyMap.set(t,n);if(r=new EventInfo(t,s,e),n.push(r),n.sort((t,e)=>t.priority-i),this.callerMap.has(s)){n=this.callerMap.get(s);for(const i of n)i.key==t&&i.handler==e&&console.error("事件系统 处理器关联错误："+t+" "+s+" "+e)}else n=[],this.callerMap.set(s,n);n.push(r)}off(t,e,s){if(0==this.keyMap.has(t))return;let i,n=this.keyMap.get(t),r=null;for(let t=0;t<n.length;t++)if(i=n[t],i.target==s&&i.handler==e){r=i,n.splice(t,1);break}if(this.callerMap.has(s)){n=this.callerMap.get(s);for(let s=0;s<n.length;s++)if(i=n[s],i.key==t&&i.handler==e){r=i,n.splice(s,1);break}}r&&r.destroy()}offByCaller(t){let e,s=this.callerMap.get(t);if(void 0!==s&&0!=s.length){for(;s.length;)e=s[0],this.off(e.key,e.handler,e.target);this.callerMap.delete(t)}}offAllEvent(){this.keyMap.forEach(t=>{t.forEach(t=>{t.destroy()})}),this.keyMap.clear(),this.callerMap.clear()}emit(t,e){if(0==this.keyMap.has(t))return;let s,i=this.keyMap.get(t);for(let n=0;n<i.length;n++)s=i[n],s.handler.apply(s.target,[t,this,e])}hasEvent(t){return this.keyMap.has(t)}hasEventHandler(t,e,s){if(0==this.keyMap.has(t))return!1;let i,n=this.keyMap.get(t);for(let t=0;t<n.length;t++)if(i=n[t],i.target==s&&i.handler==e)return!0;return!1}destroy(){this.callerMap.clear(),this.keyMap.clear()}}class EventInfo{constructor(t,e,s){this.key="",this.priority=255,this.key=t,this.target=e,this.handler=s}destroy(){}}class Event{static getChannel(t="main"){return this.channels.get(t)}static emit(t,e,s="main"){if(!this.channels.has(s))return;this.channels.get(s).emit(t,e)}static on(t,e,s,i=0,n="main"){let r;this.channels.has(n)?r=this.channels.get(n):(r=new EventDispatcher,this.channels.set(n,r)),r.on(t,e,s,i)}static off(t,e,s,i="main"){let n;this.channels.has(i)&&(n=this.channels.get(i),n.off(t,e,s))}static offByCaller(t,e="main"){let s;this.channels.has(e)&&(s=this.channels.get(e),s.offByCaller(t))}static offAll(t="main"){let e;this.channels.has(t)&&(e=this.channels.get(t),e.offAllEvent())}}Event.START="start",Event.PROGRESS="progress",Event.COMPLETE="complete",Event.ERROR="Error",Event.ADD="add",Event.REMOVE="remove",Event.UPDATE="update",Event.CLEAR="clear",Event.State_Changed="stateChanged",Event.channels=new Map;class Dictionary extends EventDispatcher{constructor(){super(),this.__map=new Map,this.__list=[]}set(t,e){let s;if(this.__map.has(t)){s=this.__map.get(t);const e=this.__list.indexOf(s);if(e<0)throw new Error("Dictionary内部逻辑错误！");this.__map.delete(t),this.__list.splice(e,1),this.emit(Event.REMOVE,s)}this.__map.set(t,e),this.__list.push(e),this.emit(Event.ADD,e)}has(t){return this.__map.has(t)}get(t){return this.__map.get(t)}getValue(t){if(t>=this.__list.length)throw new Error(t+"索引超出0-"+this.__list.length+"范围");return this.__list[t]}delete(t){if(!this.__map.has(t))return;const e=this.__map.get(t),s=this.__list.indexOf(e);if(s<0)throw new Error("Dictionary内部逻辑错误！");return this.__list.splice(s,1),this.__map.delete(t),this.hasEvent(Event.REMOVE)&&this.emit(Event.REMOVE,e),e}clear(){this.__map.clear(),this.__list.length=0}get elements(){return this.__list}get size(){return this.__map.size}destroy(){super.destroy(),this.__map.clear(),this.__map=null,this.__list=null}}class Debuger{static debug(t,e){this.__debuger.set(t,e)}static getLogs(t){return null!=t&&null!=t||(t="all"),this.__logs.has(t)?this.__logs.get(t):null}static __save(t,e,s){let i;this.__logs.has(t)?i=this.__logs.get(t):(i=[],this.__logs.set(t,i));let n="["+t+"]"+e+":"+s;return i.length>=this.MaxCount&&i.unshift(),i.push(n),this.__logs.has("all")?i=this.__logs.get("all"):(i=[],this.__logs.set("all",i)),i.length>=this.MaxCount&&i.unshift(),i.push(n),n}static log(t,e){let s=this.__save(t,"Log",e),i=!!this.__debuger.has("all")&&this.__debuger.get("all"),n=!!this.__debuger.has(t)&&this.__debuger.get(t);(i||n)&&console.log(s)}static err(t,e){let s=this.__save(t,"Error",e),i=!!this.__debuger.has("all")&&this.__debuger.get("all"),n=!!this.__debuger.has(t)&&this.__debuger.get(t);(i||n)&&console.error(s)}static warn(t,e){let s=this.__save(t,"Warn",e),i=!!this.__debuger.has("all")&&this.__debuger.get("all"),n=!!this.__debuger.has(t)&&this.__debuger.get(t);(i||n)&&console.warn(s)}static info(t,e){let s=this.__save(t,"Info",e),i=!!this.__debuger.has("all")&&this.__debuger.get("all"),n=!!this.__debuger.has(t)&&this.__debuger.get(t);(i||n)&&console.info(s)}}Debuger.MaxCount=Number.MAX_SAFE_INTEGER,Debuger.__logs=new Dictionary,Debuger.__debuger=new Map;class Pool{constructor(t,e){if(this.__cacheStack=new Array,this.__usingArray=new Array,this.__maxCount=0,this.__class=t,!this.__class)throw new Error("构造函数不能为空！");this.__maxCount=null==e?Number.MAX_SAFE_INTEGER:e}get count(){return this.__cacheStack.length}get usingCount(){return this.__usingArray.length}allocate(){if(this.count+this.usingCount<this.__maxCount){let t=this.__cacheStack.length>0?this.__cacheStack.pop():new this.__class;return this.__usingArray.push(t),t}throw new Error("对象池最大数量超出："+this.__maxCount)}recycle(t){if(this.__cacheStack.indexOf(t)>-1)throw new Error("重复回收！");let e=this.__usingArray.indexOf(t);if(e<0)throw new Error("对象不属于改对象池！");t.reset(),this.__usingArray.splice(e,1),this.__cacheStack.push(t)}recycleList(t){for(let e=0;e<t.length;e++){const s=t[e];this.recycle(s)}}recycleAll(){for(let t=0;t<this.__usingArray.length;t++){const e=this.__usingArray[t];this.recycle(e)}}destroy(){this.recycleAll();for(let t=0;t<this.__cacheStack.length;t++){this.__cacheStack[t].destroy()}this.__cacheStack.length=0,this.__cacheStack=null,this.__usingArray.length=0,this.__usingArray=null}}class List extends EventDispatcher{constructor(t=!0){super(),this.__only=!1,this.count=0,this.__only=t,this.__element=[]}push(t){if(this.__only){if(this.__element.indexOf(t)>=0)return!1}return this.__element.push(t),this.count=this.__element.length,this.hasEvent(Event.ADD)&&this.emit(Event.ADD,t),!0}unshift(t){if(this.__only){if(this.__element.indexOf(t)>=0)return!1}return this.__element.unshift(t),this.count=this.__element.length,this.hasEvent(Event.ADD)&&this.emit(Event.ADD,t),!0}pop(){if(this.__element.length>0){const t=this.__element.pop();return this.count=this.__element.length,this.hasEvent(Event.REMOVE)&&this.emit(Event.REMOVE,t),t}return null}shift(){if(this.__element.length>0){const t=this.__element.shift();return this.count=this.__element.length,this.hasEvent(Event.REMOVE)&&this.emit(Event.REMOVE,t),t}return null}removeAt(t){if(t>=this.__element.length)throw new Error("删除索引超出范围！");const e=this.__element[t];return this.__element.splice(t,1),this.count=this.__element.length,this.hasEvent(Event.REMOVE)&&this.emit(Event.REMOVE,e),e}remove(t){let e=this.__element.indexOf(t);if(e<0)throw new Error("要删除的内容不在列表中！"+t);const s=this.__element[e];this.__element.splice(e,1),this.count=this.__element.length,this.hasEvent(Event.REMOVE)&&this.emit(Event.REMOVE,s)}clear(){this.count=0,this.__element.length=0,this.hasEvent(Event.CLEAR)&&this.emit(Event.CLEAR)}has(t){return this.find(t)>=0}find(t){return this.__element.indexOf(t)}findIndex(t){return this.__element.findIndex(t)}get(t){if(t>=this.__element.length)throw new Error("超出索引范围:"+t+"/"+this.__element.length);return this.__element[t]}get elements(){return this.__element}}class TickerManagerImpl{constructor(){this.__tickerRoot=find("TickerManager"),this.__tickerRoot||(this.__tickerRoot=new Node("TickerManager"),director.getScene().addChild(this.__tickerRoot)),this.__tickerManager=this.__tickerRoot.addComponent(TickManagerComponent)}addTicker(t){this.__tickerManager.addTicker(t)}removeTicker(t){this.__tickerManager.removeTicker(t)}callNextFrame(t,e){this.__tickerManager.callNextFrame(t,e)}clearNextFrame(t,e){this.__tickerManager.clearNextFrame(t,e)}}class TickManagerComponent extends Component{constructor(){super(...arguments),this.__tickerList=[],this.__nextFrameCallBacks=[]}update(t){let e;for(;this.__nextFrameCallBacks.length;)e=this.__nextFrameCallBacks.shift(),e.callBack.apply(e.caller);for(let e=0;e<this.__tickerList.length;e++){this.__tickerList[e].tick(t)}}addTicker(t){if(this.__tickerList.indexOf(t)>=0)throw new Error("Ticker 重复添加！");this.__tickerList.push(t)}removeTicker(t){let e=this.__tickerList.indexOf(t);if(e<0)throw new Error("找不到要删除的Tick！");this.__tickerList.splice(e,1)}callNextFrame(t,e){for(let s=0;s<this.__nextFrameCallBacks.length;s++){if(this.__nextFrameCallBacks[s].equal(t,e))return}this.__nextFrameCallBacks.push(new NextFrameHandler(t,e))}clearNextFrame(t,e){for(let s=0;s<this.__nextFrameCallBacks.length;s++){this.__nextFrameCallBacks[s].equal(t,e)&&this.__nextFrameCallBacks.splice(s,1)}}}class NextFrameHandler{constructor(t,e){this.callBack=t,this.caller=e}equal(t,e){return this.caller===e&&this.callBack===t}}class TickerManager{static addTicker(t){this.impl.addTicker(t)}static removeTicker(t){this.impl.removeTicker(t)}static callNextFrame(t,e){this.impl.callNextFrame(t,e)}static clearNextFrame(t,e){this.impl.clearNextFrame(t,e)}static get impl(){return null==this.__impl&&(this.__impl=Injector.getInject(this.KEY)),null==this.__impl&&(this.__impl=new TickerManagerImpl),this.__impl}}TickerManager.KEY="TickerManager";class TimerImpl{constructor(){this.__lastTime=0,this.reset(),TickerManager.addTicker(this)}reset(){this.__lastTime=Date.now()/1e3}tick(t){this.__lastTime+=t}get currentTime(){return this.__lastTime}get absTime(){return this.reset(),this.currentTime}}class Timer{static get currentTime(){return this.impl.currentTime}static get absTime(){return this.impl.absTime}static reset(t){this.impl.reset(t)}static get impl(){return null==this.__impl&&(this.__impl=Injector.getInject(this.KEY)),null==this.__impl&&(this.__impl=new TimerImpl),this.__impl}}Timer.KEY="Timer";class ResManagerImpl{constructor(){this.__resDic=new Dictionary,this._waitDestory=new List,TickerManager.addTicker(this)}tick(t){ResManager.AUTO_GC&&this.gc()}addRes(t){if(this.__resDic.has(t.key))throw new Error("重复添加资源！");this.__resDic.set(t.key,t),this._waitDestory.push(t),t.lastOpTime=Timer.currentTime}hasRes(t){return this.__resDic.has(t)}_getRes(t){return this.__resDic.get(t)}addResRef(t,e){if(!this.__resDic.has(t))throw new Error("未找到资源："+t);let s=this.__resDic.get(t);return this._waitDestory.has(s)&&this._waitDestory.remove(s),s.lastOpTime=Timer.currentTime,s.addRef(e)}removeResRef(t){if(!this.__resDic.has(t.key))throw new Error("未找到资源："+t.key);let e=this.__resDic.get(t.key);e.removeRef(t),0==e.refLength&&this._waitDestory.push(e),e.lastOpTime=Timer.currentTime}gc(t){let e,s=Timer.currentTime,i=this._waitDestory.elements;for(let n=0;n<i.length;n++)e=i[n],e.refCount>0||(1==t||s-e.lastOpTime>ResManager.GC_TIME)&&(this.destoryRes(e),n--)}destoryRes(t){this.__resDic.delete(t.key),t.destroy()}get resList(){return this.__resDic.elements}}class ResManager{static addRes(t){this.impl.addRes(t)}static hasRes(t){return this.impl.hasRes(t)}static _getRes(t){return this.impl._getRes(t)}static addResRef(t,e){return this.impl.addResRef(t,e)}static removeResRef(t){return this.impl.removeResRef(t)}static gc(t){return this.impl.gc(t)}static resList(){return this.impl.resList}static get impl(){return null==this.__impl&&(this.__impl=Injector.getInject(this.KEY)),null==this.__impl&&(this.__impl=new ResManagerImpl),this.__impl}}ResManager.KEY="ResManager",ResManager.GC_TIME=15,ResManager.AUTO_GC=!0;class ResRef{constructor(){this.key="",this.__isDispose=!1}dispose(){if(this.__isDispose)throw new Error("重复释放资源引用");this.__isDispose=!0,ResManager.removeResRef(this)}get isDispose(){return this.__isDispose}reset(){this.key="",this.refKey=void 0,this.content=null,this.__isDispose=!1}destroy(){this.key="",this.refKey=void 0,this.content=null}}function url2Key(t){return ResURLUtils.url2Key(t)}function key2URL(t){return ResURLUtils.key2Url(t)}class ResURLUtils{static getAssetType(t){if(!this.__assetTypes.has(t))throw new Error("未找到对应资源类型："+t);return this.__assetTypes.get(t)}static key2Url(t){if(t.indexOf("|")){let e=t.split("|");return{url:e[0],bundle:e[1],type:this.getAssetType(e[2])}}return t}static url2Key(t){return null==t||null==t?"":"string"==typeof t?t:t.url+"|"+t.bundle+"|"+this.getClassName(t.type)}static getClassName(t){let e;e="string"!=typeof t?t.toString():t,e=e.replace("function ","");let s=e.indexOf("()");if(s<0)throw new Error("获取类型名称错误："+e);return e=e.substring(0,s),this.__assetTypes.has(e)||this.__assetTypes.set(e,t),e}}ResURLUtils.__assetTypes=new Map;class AudioChannel{constructor(t,e){null==e&&(e=t.addComponent(AudioSource)),this.__node=t,this.__source=e}get url(){return this.__url}get mute(){return this.__mute}set mute(t){this.__mute!=t&&(this.__mute=t,this.__mute?(this.__volume=this.__source.volume,this.__source.volume=0):this.__source.volume=this.__volume)}play(t,e,s,i,n=!1,r=1){this.__reset(),this.__url=t,this.__playedComplete=e,this.__isPlaying=!0,this.__speed=r,this.__loop=n,i?(i.time<=0&&(this.mute?this.__volume=s:this.__source.volume=s),null==this.__fadeData&&(this.__fadeData=new FadeData),this.__fadeData.startTime=director.getTotalTime(),this.__fadeData.startValue=null==i.startVolume?this.__source.volume:i.startVolume,this.__fadeData.time=i.time,this.__fadeData.endValue=s,this.__fadeData.complete=i.complete,this.__fadeData.completeStop=i.completeStop):this.__volume=s,this.__startTime=director.getTotalTime(),this.__time=Number.MAX_VALUE,Res.getResRef(this.url,"AudioChannel").then(t=>{if(t instanceof ResRef){if(0==this.__isPlaying)return void t.dispose();if(url2Key(this.url)!=t.key)return void t.dispose();this.__ref=t,this.__play()}},t=>{console.error(t),this.__isPlaying=!1,this.__source.stop()})}stop(){this.__source.playing&&this.__source.stop(),this.__isPlaying=!1,this.__reset()}get isPlaying(){return this.__isPlaying||this.__source.playing}fade(t,e,s,i,n){this.isPlaying&&(this.__paused=!1,t<=0?(this.mute?this.__volume=e:this.__source.volume=e,n&&(this.stop(),i&&i())):(null==this.__fadeData&&(this.__fadeData=new FadeData),this.__fadeData.startTime=director.getTotalTime(),this.__fadeData.startValue=null==s?this.__source.volume:s,this.__fadeData.time=t,this.__fadeData.endValue=e,this.__fadeData.complete=i,this.__fadeData.completeStop=n))}__reset(){this.__url=null,this.__ref&&(this.__ref.dispose(),this.__ref=null),this.__isPlaying=!1,this.__paused=!1,this.__fadeData=null}__clipLoaded(t,e){if(t)return console.error(t.message),this.__isPlaying=!1,void this.__source.stop();if(0==this.__isPlaying)return void e.dispose();url2Key(this.url)==e.key?(this.__ref=e,this.__play()):e.dispose()}__play(){this.__source.clip=this.__ref.content,this.__source.loop=this.__loop,this.__source.play();let t=director.getTotalTime();this.__fadeData?(this.__fadeData.startTime=t,this.mute?this.__volume=this.__fadeData.startValue:this.__source.volume=this.__fadeData.startValue):this.mute?this.__source.volume=0:this.__source.volume=this.__volume,this.__startTime=director.getTotalTime(),this.__time=1e3*this.__source.duration}tick(t){if(this.__paused||0==this.__isPlaying||null==this.__url)return;let e,s=director.getTotalTime();if(this.__fadeData){e=s-this.__fadeData.startTime;let t=e/this.__fadeData.time;if(t=t>1?1:t,this.mute?this.__volume=this.__fadeData.startValue+(this.__fadeData.endValue-this.__fadeData.startValue)*t:this.__source.volume=this.__fadeData.startValue+(this.__fadeData.endValue-this.__fadeData.startValue)*t,1==t){let t=this.__fadeData.complete;this.__fadeData.completeStop&&(this.__source.stop(),this.__isPlaying=!1,this.__reset()),t&&t(),this.__fadeData=null}}this.__loop||(e=s-this.__startTime,e/this.__time>=1&&(this.__source.stop(),this.__isPlaying=!1,this.__playedComplete&&this.__playedComplete(),this.__reset()))}resume(){if(0==this.__paused)return;let t=director.getTotalTime()-this.__pauseTime;this.__fadeData&&(this.__fadeData.startTime+=t),this.__startTime+=t,this.__source.play(),this.__paused=!1}pause(){this.__paused||(this.__paused=!0,this.__pauseTime=director.getTotalTime(),this.__source.pause())}get curVolume(){return this.__source.volume}}class FadeData{}class AudioManagerImpl{constructor(){let t;this.__musicChannelIndex=0,this.__volume=1,this.__musicVolume=1,this.__musicChannels=[],this.__soundChannels=[],TickerManager.addTicker(this),this.__audioRoot=find("AudioManager"),null==this.__audioRoot&&(this.__audioRoot=new Node("AudioManager"),director.getScene().addChild(this.__audioRoot));for(let e=0;e<2;e++)t=new AudioChannel(this.__audioRoot),this.__musicChannels.push(t)}get volume(){return this.__volume}set volume(t){if(this.__volume==t)return;let e,s;this.__volume=t;for(let t=0;t<this.__musicChannels.length;t++)s=this.__musicChannels[t],s.isPlaying&&(e=s.volume*this.__musicVolume*this.__volume,s.fade(100,e,s.curVolume));for(let t=0;t<this.__soundChannels.length;t++)s=this.__soundChannels[t],s.isPlaying&&(e=s.volume*this.__soundVolume*this.__volume,s.fade(100,e,s.curVolume))}set musicVolume(t){if(this.__musicVolume==t)return;if(this.__musicVolume=t,this.muteMusic)return;let e=this.__musicChannels[this.__musicChannelIndex];if(e&&e.isPlaying){let t=e.volume*this.__musicVolume*this.__volume;e.fade(100,t,e.curVolume)}}get musicVolume(){return this.__musicVolume}get soundVolume(){return this.__soundVolume}set soundVolume(t){if(this.__soundVolume==t)return;let e;this.__soundVolume=t;for(let t=0;t<this.__soundChannels.length;t++)if(e=this.__soundChannels[t],e.isPlaying){let t=e.volume*this.__soundVolume*this.__volume;e.fade(100,t,e.curVolume)}}set mute(t){this.__mute!=t&&(this.__mute=t,this.__changedMutes())}get mute(){return this.__mute}get muteMusic(){return this.__muteMusic}set muteMusic(t){this.__muteMusic!=t&&(this.__muteMusic=t,this.__changedMutes())}get muteSound(){return this.__muteSound}set muteSound(t){this.__muteSound!=t&&(this.__muteSound=t,this.__changedMutes())}__changedMutes(){for(let t=0;t<this.__musicChannels.length;t++){this.__musicChannels[t].mute=this.muteMusic||this.mute}for(let t=0;t<this.__soundChannels.length;t++){this.__soundChannels[t].mute=this.muteSound||this.mute}}playMusic(t,e,s,i){let n;n=this.muteMusic||this.mute?0:e*this.__musicVolume*this.__volume;let r,_=this.__musicChannels[this.__musicChannelIndex];_&&_.isPlaying&&url2Key(_.url)==url2Key(t)||(this.__musicChannelIndex++,this.__musicChannelIndex=this.__musicChannelIndex%2,0==this.__musicChannelIndex?(_=this.__musicChannels[0],r=this.__musicChannels[1]):(_=this.__musicChannels[1],r=this.__musicChannels[0]),r.isPlaying&&r.fade(500,0,void 0,null,!0),_.volume=e,_.play(t,null,n,{time:500,startVolume:0},!0,s))}stopMusic(){let t=this.__musicChannels[this.__musicChannelIndex];t&&t.isPlaying&&t.stop()}pauseMusic(){let t=this.__musicChannels[this.__musicChannelIndex];t&&t.pause()}resumeMusic(){let t=this.__musicChannels[this.__musicChannelIndex];t&&t.resume()}playSound(t,e,s,i,n){let r;r=this.muteSound||this.mute?0:this.soundVolume*s*this.__volume;let _=this.getIdleChannel();_&&(_.volume=s,_.play(t,e,r,null,n,i))}getPlaying(t){for(let e=0;e<this.__soundChannels.length;e++){const s=this.__soundChannels[e];if(s.isPlaying&&url2Key(s.url)==url2Key(t))return s}return null}getIdleChannel(){let t,e;for(t=0;t<this.__soundChannels.length;t++)if(e=this.__soundChannels[t],0==e.isPlaying)return e;return t<AudioManager.MAX_SOUND_CHANNEL_COUNT?(e=new AudioChannel(this.__audioRoot),this.__soundChannels.push(e),e):null}tick(t){for(let e=0;e<this.__musicChannels.length;e++){const s=this.__musicChannels[e];s.isPlaying&&s.tick(t)}for(let e=0;e<this.__soundChannels.length;e++){const s=this.__soundChannels[e];s.isPlaying&&s.tick(t)}}}class AudioManager{static get volume(){return this.impl.volume}static set volume(t){this.impl.volume=t}static get musicVolume(){return this.impl.musicVolume}static set musicVolume(t){this.impl.musicVolume=t}static get soundVolume(){return this.impl.soundVolume}static set soundVolume(t){this.impl.soundVolume=t}static get mute(){return this.impl.mute}static set mute(t){this.impl.mute=t}static get muteMusic(){return this.impl.muteMusic}static set muteMusic(t){this.impl.muteMusic=t}static get muteSound(){return this.impl.muteSound}static set muteSound(t){this.impl.muteSound=t}static playMusic(t,e=1,s=1,i=!1){this.impl.playMusic(t,e,s,i)}static stopMusic(){this.impl.stopMusic()}static pauseMusic(){this.impl.pauseMusic()}static resumeMusic(){this.impl.resumeMusic()}static playSound(t,e,s,i,n){this.impl.playSound(t,e,s,i,n)}static getPlaying(t){return this.impl.getPlaying(t)}static get impl(){return null==this.__impl&&(this.__impl=Injector.getInject(this.KEY)),null==this.__impl&&(this.__impl=new AudioManagerImpl),this.__impl}}AudioManager.KEY="drongo.AudioManager",AudioManager.MAX_SOUND_CHANNEL_COUNT=30;class Resource{constructor(){this.state=0,this.key="",this.lastOpTime=0,this.__refs=[],this.__content=null}reset(){}set content(t){this.__content=t,this.__content instanceof Asset&&this.__content.addRef()}get content(){return this.__content}addRef(t){let e=new ResRef;return e.key=this.key,e.refKey=t,this.content instanceof Asset?(this.content instanceof Prefab?e.content=instantiate(this.content):e.content=this.content,this.content.addRef()):e.content=this.content,this.__refs.push(e),e}removeRef(t){let e=this.__refs.indexOf(t);if(e<0)throw new Error("未找到需要删除的引用！");if(this.content instanceof Asset){if(this.content instanceof Prefab){let e=t.content;isValid(e)&&e.destroy()}this.content.decRef()}this.__refs.splice(e,1),t.destroy()}destroy(){if(this.refCount>0||this.refLength>0)throw new Error("发现销毁资源时引用数量不为0");this.__content instanceof Asset&&(this.__content.decRef(),this.__content.refCount<=0&&(Debuger.log("Res","资源销毁=>"+this.key),assetManager.releaseAsset(this.__content))),this.key="",this.__refs.length=0,this.__content=null}get refCount(){return this.__content instanceof Asset?this.__content.refCount-1:this.__refs.length}get refLength(){return this.__refs.length}}var __awaiter=function(t,e,s,i){return new(s||(s=Promise))((function(n,r){function _(t){try{h(i.next(t))}catch(t){r(t)}}function a(t){try{h(i.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(_,a)}h((i=i.apply(t,e||[])).next())}))};class Res{static setResLoader(t,e){this.__loaders.set(t,e)}static getResLoader(t){if(!this.__loaders.has(t))throw new Error("未注册的加载器："+t);return this.__loaders.get(t)}static getResRef(t,e,s){return __awaiter(this,void 0,void 0,(function*(){if(Array.isArray(t)){let i=[],n=0;for(let r=0;r<t.length;r++){const _=t[r],a=yield this.loadAsset(_,e,e=>{s&&s((n+e)/t.length)});i.push(a)}return yield Promise.all(i)}{let i=url2Key(t);return ResManager.hasRes(i)?Promise.resolve(ResManager.addResRef(i,e)):yield this.loadAsset(t,e,t=>{s&&s(t)})}}))}static loadAsset(t,e,s){return __awaiter(this,void 0,void 0,(function*(){const i=url2Key(t);if(ResManager.hasRes(i))return Promise.resolve(ResManager.addResRef(i,e));return new Promise((i,n)=>{if("string"==typeof t)throw new Error("未实现！");let r,_=assetManager.getBundle(t.bundle);_?(r="string"==typeof t.type?this.getResLoader(t.type):this.defaultAssetLoader,r(t,_,e,s,(t,e)=>{t?n(t):i(e)})):assetManager.loadBundle(t.bundle,(_,a)=>{_?n(_):(r="string"==typeof t.type?this.getResLoader(t.type):this.defaultAssetLoader,r(t,a,e,s,(t,e)=>{t?n(t):i(e)}))})})}))}static defaultAssetLoader(t,e,s,i,n){if("string"==typeof t)throw new Error("url不能为字符串"+t);if("string"==typeof t.type)throw new Error("url.type不能为字符串"+t);e.load(t.url,t.type,i,(e,i)=>{if(e)return void n(e);const r=url2Key(t);if(ResManager.hasRes(r))n(void 0,ResManager.addResRef(r,s));else{let t=new Resource;t.key=r,t.content=i,ResManager.addRes(t),n(void 0,ResManager.addResRef(r,s))}})}}Res.__loaders=new Map;class TaskQueue extends EventDispatcher{constructor(){super(),this.__index=0,this.__taskList=[]}addTask(t){if(this.__taskList.indexOf(t)>=0)throw new Error("重复添加！");this.__taskList.push(t)}removeTask(t){let e=this.__taskList.indexOf(t);if(e<0)throw new Error("未找到要删除的内容！");this.__taskList.splice(e,1)}start(t){this.__index=0,this.__tryNext()}__tryNext(){if(this.__index<this.__taskList.length){let t=this.__taskList[this.__index];t.on(Event.COMPLETE,this.__subTaskEventHandler,this),t.on(Event.PROGRESS,this.__subTaskEventHandler,this),t.on(Event.ERROR,this.__subTaskEventHandler,this),t.start()}else this.emit(Event.COMPLETE)}__subTaskEventHandler(t,e,s){if(t!=Event.PROGRESS)e.offAllEvent(),t!=Event.ERROR?(e.destroy(),this.__index++,this.__tryNext()):this.emit(Event.ERROR,s);else{let t=null==Number(s)?0:Number(s),e=(this.__index+t)/this.__taskList.length;this.emit(Event.PROGRESS,e)}}destroy(){super.destroy(),this.__taskList.length=0,this.__index=0}}class TaskSequence extends EventDispatcher{constructor(){super(),this.__taskList=new Array,this.__index=0}addTask(t){if(this.__taskList.indexOf(t)>=0)throw new Error("重复添加！");this.__taskList.push(t)}removeTask(t){let e=this.__taskList.indexOf(t);if(e<0)throw new Error("找不到要删除的内容!");this.__taskList.splice(e,1)}start(t){for(let t=0;t<this.__taskList.length;t++){const e=this.__taskList[t];e.on(Event.COMPLETE,this.__subTaskEventHandler,this),e.on(Event.ERROR,this.__subTaskEventHandler,this),e.on(Event.PROGRESS,this.__subTaskEventHandler,this),e.start()}}__subTaskEventHandler(t,e,s){t!=Event.PROGRESS?(e.offAllEvent(),t!=Event.ERROR?(this.__index++,this.__index<this.__taskList.length||(e.destroy(),this.emit(Event.COMPLETE))):this.emit(Event.ERROR,s)):this.emit(Event.PROGRESS,this.__index/this.__taskList.length)}destroy(){super.destroy(),this.__taskList.length=0,this.__index=0}}export{AudioChannel,AudioManager,Debuger,Dictionary,Event,EventDispatcher,Injector,List,Pool,Res,ResManager,ResRef,Resource,TaskQueue,TaskSequence,TickerManager,Timer,key2URL,url2Key};